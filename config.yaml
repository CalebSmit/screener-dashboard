# Multi-Factor Screener Configuration
# Version 2.0 | Last Updated: 2026-02-12

# Universe Selection
universe:
  index: 'SP500'  # Options: 'SP500', 'R1000', 'R2000'
  min_market_cap: 2e9  # $2B minimum
  # NOTE: Volume filtering is done in portfolio construction via portfolio.min_avg_dollar_volume.
  exclude_sectors: []  # e.g., ['Utilities'] to exclude a sector
  exclude_tickers: []  # e.g., ['BRK.B'] for manual exclusions

# Factor Category Weights (must sum to 100)
# Proportionally reduced from 6-factor (25/25/15/15/10/10) to accommodate Size + Investment
factor_weights:
  valuation: 22
  quality: 22
  growth: 13
  momentum: 13
  risk: 10
  revisions: 10  # Set to 0 if analyst data unavailable
  size: 5        # Fama-French SMB proxy; -log(market cap)
  investment: 5  # Fama-French CMA proxy; YoY total asset growth

# Within-Category Metric Weights (each category sums to 100)
# Rationale: Weights reflect data reliability, research support, and
# resistance to manipulation. Cash-flow metrics > accounting metrics.
metric_weights:
  valuation:
    ev_ebitda: 25      # Capital-structure-neutral; LTM EBIT + LTM D&A (quarterly cashflow)
    fcf_yield: 45      # Highest: cash flow is hardest to manipulate
    earnings_yield: 20 # Simple P/E inverse; well-understood but accrual-based
    ev_sales: 10       # Lowest: ignores margins, but useful for loss-making firms; correlated with EV/EBITDA
    pb_ratio: 0        # Bank-only; active weight in bank_metric_weights

  quality:
    roic: 27           # LTM NOPAT/IC; excess cash capped 50%, IC floored 10% TA
    gross_profit_assets: 20  # Novy-Marx quality factor; above operating expenses
    net_debt_to_ebitda: 18   # Net Debt/EBITDA; lower = better; replaces D/E (negative equity distorts D/E)
    piotroski_f_score: 15    # Composite health; 9 binary signals
    accruals: 5              # Earnings quality; Sloan 1996
    operating_leverage: 8    # Degree of Operating Leverage; lower = more durable; banks skip
    beneish_m_score: 7       # Beneish (1999) earnings manipulation detection; non-bank only
    roe: 0             # Bank-only; active weight in bank_metric_weights
    roa: 0             # Bank-only
    equity_ratio: 0    # Bank-only

  growth:
    forward_eps_growth: 45  # Highest: forward-looking consensus estimates; absorbs PEG's removed weight
    peg_ratio: 0       # Removed: P/E ÷ growth double-counts valuation (Earnings Yield = 1/PE); breaks on negative growth
    revenue_growth: 25 # Top-line growth; harder to manipulate than earnings
    revenue_cagr_3yr: 15  # 3-year revenue CAGR; smooths lumpy 1yr growth from annual filings
    sustainable_growth: 15  # LTM ROE(avg equity) × retention; SGR clamped [0%,100%]

  momentum:
    return_12_1: 40    # Classic Jegadeesh-Titman momentum signal
    return_6m: 35      # Medium-term momentum
    jensens_alpha: 25  # Risk-adjusted excess return above CAPM prediction

  risk:
    volatility: 30     # Direct risk measure
    beta: 20           # Systematic risk relative to market
    sharpe_ratio: 15   # Risk-adjusted return efficiency; higher = better
    sortino_ratio: 15  # Downside risk-adjusted return; higher = better
    max_drawdown_1y: 20  # Max peak-to-trough decline; less negative = better

  revisions:
    analyst_surprise: 38       # Backward-looking: did company beat estimates?
    price_target_upside: 12   # Forward-looking: analyst consensus upside; reduced (sell-side optimism bias)
    earnings_acceleration: 20  # Most recent surprise % > prior quarter surprise %
    consecutive_beat_streak: 20  # Count of consecutive positive surprises (0-4)
    short_interest_ratio: 10   # Days to cover (shortRatio); lower = less bearish sentiment
    # NOTE: EPS forecast revision (change in consensus FWD EPS over 3-6 months) would be
    # ideal here, but yfinance does not provide historical consensus data.
    # Future enhancement: integrate I/B/E/S data from FactSet or Refinitiv.

  size:
    size_log_mcap: 100         # Single metric: -log(market cap). Small-cap premium (Fama-French SMB)

  investment:
    asset_growth: 100          # Single metric: YoY total asset growth. Conservative = better (Fama-French CMA)

# Bank-Specific Metric Weights
# Used INSTEAD OF generic weights for bank-like financial stocks
# (banks, insurers, credit companies). Each category sums to 100.
# Growth, momentum, risk, revisions use the generic weights above.
bank_metric_weights:
  valuation:
    ev_ebitda: 0           # EV meaningless for banks
    fcf_yield: 0           # Banks lack traditional CapEx
    earnings_yield: 40     # P/E inverse; works for banks
    ev_sales: 0            # EV meaningless for banks
    pb_ratio: 60           # THE key bank valuation metric

  quality:
    roic: 0                # IC = deposits + equity; meaningless
    gross_profit_assets: 0 # Banks don't have gross profit
    debt_equity: 0         # Removed from scoring (kept for config schema compatibility)
    piotroski_f_score: 15  # Partially applicable
    accruals: 10           # Directionally valid
    beneish_m_score: 0     # Banks excluded: no COGS, no PPE, Beneish assumptions break
    roe: 35                # THE key bank profitability metric
    roa: 25                # Key bank efficiency metric
    equity_ratio: 15       # Solvency (higher = more capital = safer)

# Piotroski F-Score Conditional Weighting
# When enabled, reduces Piotroski weight for stocks with LOW valuation scores
# (i.e. expensive stocks — where F-Score has less predictive power) and
# redistributes the freed weight to specified quality metrics.
# Only affects non-bank stocks (bank quality weights are independent).
piotroski_conditional:
  enabled: true
  valuation_threshold: 50        # Stocks with valuation_score < 50 get reduced F-Score weight
  reduction_factor: 0.5          # Multiply Piotroski weight by this (0.5 = halve it)
  redistribute_to:               # Freed weight goes equally to these metrics
    - roic
    - gross_profit_assets
  growth_trap_enabled: true                          # NEW: also reduce Piotroski for growth-trap-like stocks
  growth_trap_growth_threshold: 70                   # NEW: stocks above 70th pctile growth
  growth_trap_quality_threshold: 35                  # NEW: AND below 35th pctile quality
  growth_trap_redistribute_to:                       # NEW: freed weight goes to these instead
    - accruals
    - gross_profit_assets

# Percentile Transform (optional non-linear rescaling)
# When enabled, applies a logistic S-curve to percentile ranks, compressing
# the middle and stretching the extremes. Default: disabled (no change).
percentile_transform:
  enabled: false          # Set true to activate the transform
  method: 'logistic'      # Options: 'identity' (no-op), 'logistic' (S-curve)
  logistic_steepness: 0.08  # Higher = sharper S-curve; 0.08 is moderate

# Sector Neutrality
sector_neutral:
  enabled: true
  gics_level: 'Sector'  # Currently only 'Sector' is supported
  sector_relative_composite: false  # If true, min-max normalize composite within each sector

# Value Trap Filters
# Logic: MAJORITY (2-of-3) — a stock is flagged if at least 2 of the 3
# dimensions (quality, momentum, revisions) breach their floor percentile.
# Rationale: OR logic (any 1 breach) flagged ~60% of the universe, which
# was too aggressive. Majority logic catches stocks with genuinely broad
# weakness while tolerating a single weak dimension.
value_trap_filters:
  enabled: true
  quality_floor_percentile: 30  # Exclude bottom 30% quality
  momentum_floor_percentile: 30  # Exclude bottom 30% momentum
  revisions_floor_percentile: 30  # Exclude bottom 30% revisions
  flag_only: false  # If true, flag but don't exclude; if false, exclude from portfolio

# Growth Trap Filters
# Logic: MAJORITY (2-of-3) — a stock is flagged if it has high growth but
# at least 2 of the 3 dimensions (growth ceiling, quality floor, revisions floor)
# breach their threshold. Catches "growth at any price" stocks.
growth_trap_filters:
  enabled: true
  growth_ceiling_percentile: 70  # Flag stocks ABOVE 70th percentile growth
  quality_floor_percentile: 35   # AND below 35th percentile quality
  revisions_floor_percentile: 35 # AND below 35th percentile revisions
  flag_only: false  # If true, flag but don't exclude; if false, exclude from portfolio

# Portfolio Construction
portfolio:
  num_stocks: 25
  weighting: 'score'  # Options: 'equal', 'inverse_vol', 'score' (composite-proportional)
  max_position_pct: 5.0
  # min_position_pct: not enforced — removed to avoid false confidence
  max_sector_concentration: 8  # Max 8 stocks per sector
  # Rebalance cadence: quarterly (manual). No automated rebalancing is implemented.
  min_avg_dollar_volume: 10e6  # $10M minimum 63-day avg daily dollar volume (0 to disable)

# Fetch Settings (rate-limit resilience)
fetch:
  batch_size: 30            # Tickers per batch (reduce to 10-15 if frequently rate-limited)
  max_workers: 3            # Concurrent fetch threads per batch (reduce to 1 for conservative)
  inter_batch_delay: 3.0    # Seconds between batches
  retry_failed: true        # Re-fetch failed tickers in a second pass with conservative settings
  retry_cooldown: 30        # Seconds to wait before retry pass

# Data Caching
caching:
  price_data_refresh_days: 1
  fundamental_data_refresh_days: 7
  estimate_data_refresh_days: 7
  cache_format: 'parquet'  # Options: 'parquet', 'csv'

# Data Quality
data_quality:
  winsorize_percentiles: [1, 99]  # Winsorize at 1st and 99th percentiles
  min_data_coverage_pct: 60  # Exclude stocks with < 60% of metrics available
  # max_missing_metrics: superseded by min_data_coverage_pct — removed
  metric_alert_threshold_pct: 50  # Warn if any metric is >50% missing
  auto_reduce_nan_threshold_pct: 70  # Auto-zero weight for metrics with >70% NaN
  stmt_val_strict: false  # Set true to track all _stmt_val() label misses in the DQ log
  coverage_discount:
    enabled: true
    threshold: 0.80       # Below this metric coverage ratio, discount starts
    penalty_rate: 0.15    # Composite reduced by (threshold - coverage) * penalty_rate

# Metric Clamps — pre-winsorization bounds to prevent extreme values
metric_clamps:
  forward_eps_growth: [-0.75, 1.50]  # Tightened: 300% too loose — allows distorted PEG ratios
  price_target_upside: [-0.50, 1.0]  # Unchanged — documents existing bounds
  # peg_max_cap: removed (PEG weight=0, no longer scored)

# Beneish M-Score (earnings manipulation detection)
# Uses 8-variable model from Beneish (1999) on annual financial statements.
# Non-bank stocks only. Set false to skip and redistribute quality weight.
enable_beneish: true

# Feature toggles for individual metrics
enable_short_interest_ratio: true   # Days to cover (shortRatio); lower = less bearish sentiment
enable_revenue_cagr_3yr: true       # 3-year revenue CAGR; smoothed growth signal
enable_net_debt_ebitda: true        # Net Debt/EBITDA; replaces Debt/Equity in quality scoring
enable_operating_leverage: true     # Degree of Operating Leverage (DOL); lower = more durable
enable_jensens_alpha: true          # Jensen's Alpha; risk-adjusted excess return above CAPM
enable_sharpe_ratio: true           # Sharpe Ratio; risk-adjusted return per unit of total risk

# Output
output:
  excel_file: 'factor_output.xlsx'
  factor_scores_sheet: 'FactorScores'
  write_to_cache: true
  generate_validation_report: false  # Set true to run backtest and generate report

# Backtesting (for validation)
backtesting:
  start_date: '2015-01-01'
  end_date: '2025-12-31'
  rebalance_frequency: 'monthly'
  transaction_cost_bps: 10  # 10 bps per one-way trade
  initial_capital: 1000000  # $1M
